<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout â€“ Art with Heart & Gifts (Updated 2025-01-25)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .nav { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2em; font-weight: bold; }
        .nav-links { display: flex; gap: 30px; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; }
        .nav-links a:hover { text-decoration: underline; }
        .main-content { padding: 40px 0; }
        .checkout-container { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; }
        .checkout-form { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .order-summary { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; }
        .form-section h3 { color: #667eea; margin-bottom: 20px; }
        .btn { background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s; width: 100%; }
        .btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .order-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #e0e0e0; }
        .order-item:last-child { border-bottom: none; }
        .order-item-image { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
        .order-item-details { flex: 1; }
        .order-item-title { font-weight: 600; margin-bottom: 5px; }
        .order-item-price { color: #27ae60; font-weight: 600; }
        .order-summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .order-summary-total { font-size: 1.2em; font-weight: 700; color: #333; border-top: 2px solid #e0e0e0; padding-top: 10px; margin-top: 10px; }
        .loading { text-align: center; padding: 50px; color: #666; }
        .alert { padding: 15px; border-radius: 8px; margin: 20px 0; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @media (max-width: 768px) {
            .checkout-container { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="nav">
                <div class="logo">ðŸŽ¨ Art with Heart</div>
                <div class="nav-links">
                    <a href="/">Home</a>
                    <a href="/shop.html">Shop</a>
                    <a href="/gallery.html">Gallery</a>
                    <a href="/contact.html">Contact</a>
                    <a href="/commissions.html">Commissions</a>
                    <a href="/cart.html">ðŸ›’ Cart</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="checkout-container">
                <div class="checkout-form">
                    <h1>Checkout</h1>
                    
                    
                    <form id="checkoutForm" style="display: none;">
                        <div class="form-section">
                            <h3>Shipping Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name *</label>
                                    <input type="text" id="firstName" name="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name *</label>
                                    <input type="text" id="lastName" name="lastName" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email">Email Address *</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="address">Street Address *</label>
                                <input type="text" id="address" name="address" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">City *</label>
                                    <input type="text" id="city" name="city" required>
                                </div>
                                <div class="form-group">
                                    <label for="state">State *</label>
                                    <input type="text" id="state" name="state" required>
                                </div>
                                <div class="form-group">
                                    <label for="zip">ZIP Code *</label>
                                    <input type="text" id="zip" name="zip" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Payment Information</h3>
                            <div class="form-group">
                                <label for="cardNumber">Card Number *</label>
                                <input type="text" id="cardNumber" name="cardNumber" placeholder="4111 1111 1111 1111" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="expiry">Expiry Date *</label>
                                    <input type="text" id="expiry" name="expiry" placeholder="MM/YY" required>
                                </div>
                                <div class="form-group">
                                    <label for="cvv">CVV *</label>
                                    <input type="text" id="cvv" name="cvv" placeholder="123" required>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn" id="submitBtn">Complete Purchase</button>
                    </form>
                </div>

                <div class="order-summary">
                    <h2>Order Summary</h2>
                    <div id="orderItems">
                        <div class="loading">Loading order...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cart = { items: [], total: 0 };
        let user = null;

        // Load checkout on page load
        window.onload = function() {
            loadCart();
            checkAuth();
        };

        // Check authentication - REMOVED: No login required for checkout
        function checkAuth() {
            // Always show checkout form - no login required
            document.getElementById('checkoutForm').style.display = 'block';
            document.getElementById('loginPrompt').style.display = 'none';
        }

        // Load cart
        async function loadCart() {
            try {
                const sessionId = getSessionId();
                const response = await fetch(`/api/cart/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    cart = data.cart;
                    displayOrderSummary();
                } else {
                    showError('Failed to load cart');
                }
            } catch (error) {
                showError('Error loading cart: ' + error.message);
            }
        }

        // Display order summary
        function displayOrderSummary() {
            const container = document.getElementById('orderItems');
            
            if (cart.items.length === 0) {
                container.innerHTML = '<p>Your cart is empty</p>';
                return;
            }

            let html = '';
            cart.items.forEach(item => {
                html += `
                    <div class="order-item">
                        <img src="${item.image}" alt="${item.title}" class="order-item-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4='">
                        <div class="order-item-details">
                            <div class="order-item-title">${item.title}</div>
                            <div class="order-item-price">$${item.price} x ${item.quantity}</div>
                        </div>
                    </div>
                `;
            });

            // Add totals
            const subtotal = cart.total;
            const tax = subtotal * 0.07;
            const shipping = subtotal > 100 ? 0 : 15;
            const total = subtotal + tax + shipping;

            html += `
                <div style="margin-top: 20px;">
                    <div class="order-summary-row">
                        <span>Subtotal:</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Tax (7% â€“ FL 6% + Pasco 1%):</span>
                        <span>$${tax.toFixed(2)}</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Shipping:</span>
                        <span>${shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2)}</span>
                    </div>
                    <div class="order-summary-row order-summary-total">
                        <span>Total:</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Handle form submission
        document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                const checkoutData = {
                    customerInfo: {
                        firstName: data.firstName,
                        lastName: data.lastName,
                        email: data.email,
                        phone: data.phone || '',
                        address: `${data.address}, ${data.city}, ${data.state} ${data.zip}`
                    },
                    cartItems: cart.items.map(item => ({
                        id: item.id,
                        title: item.title,
                        price: parseFloat(item.price),
                        quantity: item.quantity,
                        type: item.type || 'print',
                        size: item.size || '9in x 12in'
                    })),
                    paymentInfo: {
                        method: 'card',
                        transactionId: 'TXN-' + Date.now()
                    },
                    totalAmount: cart.total + (cart.total * 0.07) + (cart.total > 100 ? 0 : 15),
                    orderId: 'ORD-' + Date.now()
                };
                
                const response = await fetch('/api/secure-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(checkoutData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Order placed successfully! You will receive an email confirmation shortly.', 'success');
                    // Redirect to success page or clear cart
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    showAlert('Error placing order: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Error placing order: ' + error.message, 'error');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Get or create session ID
        function getSessionId() {
            let sessionId = localStorage.getItem('artwithheart_session');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('artwithheart_session', sessionId);
            }
            return sessionId;
        }

        // Show alert
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.querySelector('.checkout-form').insertBefore(alert, document.querySelector('.checkout-form').firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Show error
        function showError(message) {
            const container = document.getElementById('orderItems');
            container.innerHTML = `<div class="alert alert-error">${message}</div>`;
        }
    </script>
</body>
</html>